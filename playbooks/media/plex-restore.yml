---
###
# Playbook will restore a Plex Media Server
###

- hosts: plex
  gather_facts: false
  tasks:
  - name: ovirt-auth
    import_role:
      name: ovirt

  - name: create-vm
    import_role:
      name: ovirt
      tasks_from: create-vm.yml

  - name:
    file:
      state: directory
      path: /plex
      mode: 0755

  - name: 
    dnf:
      name: nfs-utils
      state: latest

  - name:
    mount:
      path: /plex
      src: "nas01.kywa.io:/volume1/plex"
      fstype: nfs
      state: mounted

  - name: Install Plex RPM
    shell: rpm -i /plex/pms-latest.rpm
    ignore_errors: true

  - name: Restore Systemd unit
    copy:
      remote_src: yes
      src: /plex/plexmediaserver.service
      dest: "{{ systemd_unit_file }}"

  - name: Restore Plex Library data
    unarchive:
      remote_src: yes
      src: "/plex/libbackup.tgz"
      dest: "{{ plex_library_dir }}"

  - name: Open Plex Server Port on Firewall
    firewalld:
      port:  "32400/tcp"
      permanent: yes
      state: enabled

  - name: Restart Plex Service
    systemd:
      name: plexmediaserver
      state: restarted

  collections:
  - ovirt.ovirt
